<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>Virtual Fence</title>

	<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap-theme.min.css">

	<style type="text/css">
		body {margin: 0; padding: 0;}
		html, body, #map {height: 100%;}

		@-moz-keyframes pulsate {from {-moz-transform: scale(0.25); opacity: 1;} 95% {-moz-transform: scale(1.3); opacity: 0;} to {-moz-transform: scale(0.3); opacity: 0;}}
		@-webkit-keyframes pulsate {from {-moz-transform: scale(0.25); opacity: 1;} 95% {-moz-transform: scale(1.3); opacity: 0;} to {-moz-transform: scale(0.3); opacity: 0;}}

		#map div.gmnoprint[title="Here I am"] {-moz-animation: pulsate 1.5s ease-in-out infinite; -webkit-animation: pulsate 1.5s ease-in-out infinite; border: 1px solid #fff; -moz-border-radius: 51px; -webkit-border-radius: 51px; border-radius: 51px; -moz-box-shadow: inset 0 0 5px #06f, inset 0 0 5px #06f, inset 0 0 5px #06f, 0 0 5px #06f, 0 0 5px #06f, 0 0 5px #06f; -webkit-box-shadow: inset 0 0 5px #06f, inset 0 0 5px #06f, inset 0 0 5px #06f, 0 0 5px #06f, 0 0 5px #06f, 0 0 5px #06f; box-shadow: inset 0 0 5px #06f, inset 0 0 5px #06f, inset 0 0 5px #06f, 0 0 5px #06f, 0 0 5px #06f, 0 0 5px #06f; margin:-18px 0 0 -18px; width: 51px !important; height: 51px !important;}
		#map div.gmnoprint[title="Here I am"] img {display: none;}
		@media only screen and (-webkit-min-device-pixel-ratio: 1.5), only screen and (device-width: 768px) {#map div.gmnoprint[title="Here I am"] {margin: -10px 0 0 -10px;}}
	</style>

	<!--[if lt IE 9]>
		<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
		<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
	<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=drawing,geometry"></script>

	<script type="text/javascript">        
        var map;

        var fences = [];
        var devices = [];
        
        function initialize()
        {
            var mapOptions = {
				zoom: 17,
				center: new google.maps.LatLng( 36.94929 , 127.90739 ),
				disableDefaultUI: true
			};

			map = new google.maps.Map( document.getElementById( 'map' ) , mapOptions );
            
            var markerImage = new google.maps.MarkerImage( 'bluedot_retina.png' , null , null , new google.maps.Point( 8 , 8 ) , new google.maps.Size( 17 , 17 ) );
            var drawingManager = new google.maps.drawing.DrawingManager( {
				drawingMode: null,
				drawingControl: true,
				drawingControlOptions: {
					position: google.maps.ControlPosition.TOP_RIGHT,
					drawingModes: [
                        google.maps.drawing.OverlayType.MARKER,
                        // google.maps.drawing.OverlayType.CIRCLE,
                        // google.maps.drawing.OverlayType.RECTANGLE,
                        google.maps.drawing.OverlayType.POLYGON
                    ]
				},
				markerOptions: {
					flat: true,
					icon: markerImage,
					optimized: false,
					title: 'Device',
					visible: true
				},
				circleOptions: {
					strokeColor: "#FF0000",
					strokeOpacity: 0.8,
					strokeWeight: 2,
					fillColor: "#FF0000",
					fillOpacity: 0.35
				},
				rectangleOptions: {					
					strokeColor: "#FF0000",
					strokeOpacity: 0.8,
					strokeWeight: 2,
					fillColor: "#FF0000",
					fillOpacity: 0.35
				},
				polygonOptions: {
					strokeColor: "#FF0000",
					strokeOpacity: 0.8,
					strokeWeight: 2,
					fillColor: "#FF0000",
					fillOpacity: 0.35
				}
			} );

			drawingManager.setMap( map );

			google.maps.event.addListener( drawingManager , 'markercomplete' , function( marker ) {
				drawingManager.setDrawingMode( null );

				var warnCircleOptions = {
					strokeColor: '#000000',
					strokeOpacity: 1,
					strokeWeight: 1,
					fillColor: '#000000',
					fillOpacity: 0.25,
					radius: 10,
					center: marker.getPosition(),
					zindex: 10
				},
				dangerCircleOptions = {
					strokeColor: '#000000',
					strokeOpacity: 1,
					strokeWeight: 1,
					fillColor: '#000000',
					fillOpacity: 0.25,
					radius: 5,
					center: marker.getPosition(),
					zindex: 10
				};

				var warnCircle = new google.maps.Circle( warnCircleOptions ),
					dangerCircle = new google.maps.Circle( dangerCircleOptions );

				device = {
					'marker': marker,
					'warn': warnCircle,
					'danger': dangerCircle
				};
				devices.push( device );

				google.maps.event.addListener( marker , 'mouseover' , function() {	
					warnCircle.setMap( map );
					dangerCircle.setMap( map );
				} );

				google.maps.event.addListener( marker , 'mouseout' , function() {
					warnCircle.setMap( null );
					dangerCircle.setMap( null );
				} );
			} );
            
            google.maps.event.addListener( drawingManager , 'polygoncomplete' , function( polygon ) {
                
                drawingManager.setDrawingMode( null );
				
				fences.push( polygon );
                
                google.maps.event.addListener( polygon , 'click' , function() {
                	polygon.setDraggable( true );
                	polygon.setEditable( true );

            
            		google.maps.event.addListener( map , 'click' , function() {
	                	polygon.setDraggable( false );
    	            	polygon.setEditable( false );
					} );
                } );

                google.maps.event.addListener( polygon , 'rightclick' , function() {
                	polygon.setMap( null );
                } );
                
            } );
            
            google.maps.event.addListener( map , 'idle' , function() {			
			} );
        }
        
        google.maps.event.addDomListener( window , 'load' , initialize );
        
        if( !google.maps.Polygon.prototype.getBounds )
        {
        	 google.maps.Polygon.prototype.getBounds = function()
        	 {
        	 	var bounds = new google.maps.LatLngBounds();

        	 	this.getPath().forEach( function( element , index ) {
        	 		bounds.extend( element );
        	 	} );

        	 	return bounds;
        	 }
        }

        /*
        if( !google.maps.Polygon.prototype.overlap )
        {
        	google.maps.Polygon.prototype.overlap = function( circle )
        	{
        		var contains = google.maps.geometry.poly.containsLocation;

        		var x = circle.getCenter(),
        			r = circle.getRadius();

        		var px = fromLatLngToPoint( x , map );
        		var x1 = px.x, y1 = px.y;

        		return contains( x , this ) || polygonEdges( polygonEdges( this.edges() ) ).some( function( line ) { return pointLineSegmentDistance( [ x1 , y1 ] , line ) < r } );
        	}
        }
        */

        /*
        if( !google.maps.Polygon.prototype.edges )
        {
        	google.maps.Polygon.prototype.edges = function()
        	{
        		var polygon = [];

        		this.getPath().forEach( function( element , index ) {
        			polygon.push( element );
        		} );

        		return polygon.map( function( p , i ) {
        			return i ? [ polygon[ i - 1 ] , p ] : [ polygon [ polygon.length - 1 ] , p ];
        		} );
        	}
        }
        */

         if( !google.maps.LatLng.prototype.toPoint )
         {
        	google.maps.LatLng.prototype.toPoint = function()
        	{
        		var topRight = map.getProjection().fromLatLngToPoint( map.getBounds().getNorthEast() );
        		var bottomLeft = map.getProjection().fromLatLngToPoint( map.getBounds().getSouthWest() );

        		var scale = Math.pow( 2 , map.getZoom() );

        		var worldPoint = map.getProjection().fromLatLngToPoint( this );

        		return [ ( worldPoint.x - bottomLeft.x ) * scale , ( worldPoint.y - topRight.y ) * scale ];
        	}
         }

        if( !google.maps.Polygon.prototype.edges )
        {
        	google.maps.Polygon.prototype.edges = function()
        	{
        		var polygon = [];

        		this.getPath().forEach( function( element , index ) {
        			polygon.push( element.toPoint() );
        		} );

        		return polygon.map( function( p , i ) {
        			return i ? [ polygon[ i - 1 ] , p ] : [ polygon [ polygon.length - 1 ] , p ];
        		} );
        	}
        }
        
        function pointLineSegmentDistance( point , line )
        {
        	var v = line[ 0 ], w = line[ 1 ];
        	var d, t;

        	return Math.sqrt( pointPointSquaredDistance( point , ( d = pointPointSquaredDistance( v , w ) ) ? ( ( t = ( ( point[ 0 ] - v[ 0 ] ) * ( w[ 0 ] - v[ 0 ] ) + ( point[ 1 ] - v[ 1 ] ) * ( w[ 1 ] - v[ 1 ] ) ) / d ) < 0 ? v : t > 1 ? w : [ v[ 0 ] + t * ( w[ 0 ] - v[ 0 ] ) , v[ 1 ] + t * ( w[ 1 ] - v[ 1 ] ) ] ) : v ) );
        }

        function pointPointSquaredDistance( v , w )
        {
        	var dx = v[ 0 ] - w[ 0 ],
        		dy = v[ 1 ] - w[ 1 ];

        	return dx * dx + dy * dy;
        }

        if( !google.maps.Polygon.prototype.intersect )
        {
        	google.maps.Polygon.prototype.intersect = function( position , radius )
        	{
        		var contains = google.maps.geometry.poly.containsLocation;

        		var polyline = this.edges();
        		var circle = position.toPoint();

        		return contains( position , this ) || polyline.some( function( line ) { return pointLineSegmentDistance( circle , line ) < radius; } );
        	}
        }

        $( document ).ready( function() {
	        var timer = setInterval(function() {
	        	$.each( fences , function( index , fence ) {
	        		$.each( devices , function( index , device ) {
	        			if( google.maps.geometry.poly.containsLocation( device.marker.getPosition() , fence ) === true )
		        		{
		        			device.marker.setTitle( 'Inner' );
		        		}
		        		else
		        		{
		        			device.marker.setTitle( 'Outer' );
		        		}

		        	} );
	        	} );
        	}, 1000);
        } );
    </script>
</head>
<body>
	<div id="map"></div>
</body>
</html>